Setup
20/11/2021


Uninstall Multipass	if installed
Ubuntu Software Center	install Multipass

multipass list
multipass version


Week 1
Week 1	Lab Setup
#3.	Building and Validating the Lab Environment

multipass launch 21.04 --disk 10G -n ccol2ebpf
multipass shell ccol2ebpf


git clone https://github.com/libbpf/libbpf.git
git clone https://github.com/libbpf/libbpf-bootstrap.git

LIBBPF
cd libbpf/src
make


LIBBPF	BOOTSTRAP
cd ../../libbpf-bootstrap/
git submodule update --init --recursive



Week 2	Installing the Tools for GCP and Kubernetes on Your VM

multipass launch 21.04 --disk 10G -n ccol2ebpf
multipass shell ccol2ebpf

sudo apt update
sudo apt install -y python-is-python3

ssh-keygen -f ~/.ssh/google_compute_engine -N "" -b 4096

KUBECTL
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

CALICOCTL
curl -o calicoctl -O -L  "https://github.com/projectcalico/calicoctl/releases/download/v3.20.0/calicoctl"
sudo install -o root -g root -m 0755 calicoctl /usr/local/bin/calicoctl


GOOGLE SDK
curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-356.0.0-linux-x86_64.tar.gz
gunzip google-cloud-sdk-356.0.0-linux-x86_64.tar.gz
tar xvf google-cloud-sdk-356.0.0-linux-x86_64.tar
./google-cloud-sdk/install.sh

exit
multipass shell ccol2ebpf


Week 2	Initialising and Authenticating to GCP
./google-cloud-sdk/bin/gcloud init

Launch browser
Login into Google
steven_boland@hotmail.com

Copy + paste URL into browser
Copy + paste verification code


gcloud auth login
gcloud config set project steveproebpf
gcloud config list


Weej 2	Deploy Calico w/ eBPF
#3	Setting up some Basic Networking and Virtual Machines
gcloud compute project-info add-metadata --metadata google-compute-default-region=us-central1,google-compute-default-zone=us-central1-a


Login as steven_boland@hotmail.com
Created: steveproebpf
Created: SteveProBilling

Enabling service [compute.googleapis.com] on project [730223911331]...
HAD to link SteveProBilling

Enabling service [compute.googleapis.com] on project [730223911331]...
Operation "operations/acf.p2-730223911331-8cf85218-1301-4f68-92e6-da2afa013f60" finished successfully.
Updated [https://www.googleapis.com/compute/v1/projects/steveproebpf].



Created [https://www.googleapis.com/compute/v1/projects/steveproebpf/global/networks/ccol2ebpf-vpc].
NAME           SUBNET_MODE  BGP_ROUTING_MODE  IPV4_RANGE  GATEWAY_IPV4
ccol2ebpf-vpc  CUSTOM       REGIONAL


gcloud compute networks subnets create ccol2ebpf-subnet \
  --network ccol2ebpf-vpc \
  --range 10.240.0.0/24

region
us-central1


Created [https://www.googleapis.com/compute/v1/projects/steveproebpf/regions/us-central1/subnetworks/ccol2ebpf-subnet].
NAME              REGION       NETWORK        RANGE          STACK_TYPE  IPV6_ACCESS_TYPE  IPV6_CIDR_RANGE  EXTERNAL_IPV6_CIDR_RANGE
ccol2ebpf-subnet  us-central1  ccol2ebpf-vpc  10.240.0.0/24  IPV4_ONLY


gcloud compute firewall-rules create ccol2ebpf-vpc-allow-internal \
  --allow tcp,udp,icmp \
  --network ccol2ebpf-vpc \
  --source-ranges 10.240.0.0/24


Creating firewall...\u2839Created [https://www.googleapis.com/compute/v1/projects/steveproebpf/global/firewalls/ccol2ebpf-vpc-allow-internal].
Creating firewall...done.                                                                                
NAME                          NETWORK        DIRECTION  PRIORITY  ALLOW         DENY  DISABLED
ccol2ebpf-vpc-allow-internal  ccol2ebpf-vpc  INGRESS    1000      tcp,udp,icmp        False


MY_PUBLIC_IP_AND_MASK=`curl -s https://checkip.amazonaws.com`/32
87.198.108.60/32



gcloud compute firewall-rules create ccol2ebpf-vpc-allow-external \
  --allow tcp:22,tcp:6443,icmp \
  --network ccol2ebpf-vpc \
  --source-ranges 87.198.108.60/32


Creating firewall...\u2839Created [https://www.googleapis.com/compute/v1/projects/steveproebpf/global/firewalls/ccol2ebpf-vpc-allow-external].
Creating firewall...done.                                                                                
NAME                          NETWORK        DIRECTION  PRIORITY  ALLOW                 DENY  DISABLED
ccol2ebpf-vpc-allow-external  ccol2ebpf-vpc  INGRESS    1000      tcp:22,tcp:6443,icmp        False



gcloud compute instances create ccol2ebpf-controller \
    --async \
    --boot-disk-size 200GB \
    --can-ip-forward \
    --image ubuntu-2004-focal-v20210908 \
    --image-project ubuntu-os-cloud \
    --machine-type n1-standard-2 \
    --private-network-ip 10.240.0.11 \
    --scopes compute-rw,storage-ro,service-management,service-control,logging-write,monitoring \
    --subnet ccol2ebpf-subnet \
    --zone us-central1-a \
    --tags ccol2ebpf,controller

NOTE: The users will be charged for public IPs when VMs are created.
Instance creation in progress for [ccol2ebpf-controller]: https://www.googleapis.com/compute/v1/projects/steveproebpf/zones/us-central1-a/operations/operation-1637417979566-5d13915055ae9-6607b430-a1bc89bc
Use [gcloud compute operations describe URI] command to check the status of the operation(s).


87.198.108.60/32
https://www.googleapis.com/compute/v1/projects/steveproebpf/zones/us-central1-a/operations/operation-1637417979566-5d13915055ae9-6607b430-a1bc89bc


gcloud compute operations describe https://www.googleapis.com/compute/v1/projects/steveproebpf/zones/us-central1-a/operations/operation-1637417979566-5d13915055ae9-6607b430-a1bc89bc


id: '2110875892597439763'
insertTime: '2021-11-20T06:19:41.078-08:00'
kind: compute#operation
name: operation-1637417979566-5d13915055ae9-6607b430-a1bc89bc
operationType: insert
progress: 100
selfLink: https://www.googleapis.com/compute/v1/projects/steveproebpf/zones/us-central1-a/operations/operation-1637417979566-5d13915055ae9-6607b430-a1bc89bc
startTime: '2021-11-20T06:19:41.710-08:00'
status: DONE
targetId: '552914696822635795'
targetLink: https://www.googleapis.com/compute/v1/projects/steveproebpf/zones/us-central1-a/instances/ccol2ebpf-controller
user: steven_boland@hotmail.com
warnings:
- code: DISK_SIZE_LARGER_THAN_IMAGE_SIZE
  data:
  - key: disk_size_gb
    value: '200'
  - key: image_size_gb
    value: '10'
  message: "Disk size: '200 GB' is larger than image size: '10 GB'. You might need\
    \ to resize the root repartition manually if the operating system does not support\
    \ automatic resizing. See https://cloud.google.com/compute/docs/disks/add-persistent-disk#resize_pd\
    \ for details."
zone: https://www.googleapis.com/compute/v1/projects/steveproebpf/zones/us-central1-a



Create 3x VMs
for i in 0 1 2; do
  gcloud compute instances create ccol2ebpf-worker-${i} \
    --async \
    --boot-disk-size 200GB \
    --can-ip-forward \
    --image ubuntu-2004-focal-v20210908 \
    --image-project ubuntu-os-cloud \
    --machine-type n1-standard-2 \
    --private-network-ip 10.240.0.2${i} \
    --scopes compute-rw,storage-ro,service-management,service-control,logging-write,monitoring \
    --subnet ccol2ebpf-subnet \
    --zone us-central1-a \
    --tags ccol2ebpf,worker
done


gcloud compute instances list --filter="name~ccol2ebpf"


Week 2	Deploy Calico w/ eBPF
#4	Using Kubeadm To Bootstrap a Cluster
for i in `gcloud compute instances list --filter="name~ccol2ebpf" | grep -v NAME | awk '{print $1}'`; do echo $i; done